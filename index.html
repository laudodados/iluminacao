<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Gerador de Laudo Técnico - Iluminação</title>
  <style>
    /* --- ESTILO GERAL E CORES --- */
    :root {
      --cor-primaria: #007bff;
      --cor-fundo: #8ea4d0;
      --cor-card: #ffffff;
      --cor-borda: #dee2e6;
      --cor-sombra: rgba(0, 0, 0, 0.1);
      --cor-texto: #495057;
      --cor-titulo: #212529;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: var(--cor-fundo);
      color: var(--cor-texto);
    }
    h1 {
      text-align: center;
      color: var(--cor-titulo);
    }
    /* --- ESTRUTURA DO FORMULÁRIO --- */
    .form-section {
      border: 1px solid var(--cor-borda);
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      background-color: var(--cor-card);
      box-shadow: 0 4px 8px var(--cor-sombra);
    }
    .form-group {
      margin-bottom: 18px;
    }
    label {
      display: block;
      font-weight: bold;
      margin-bottom: 6px;
    }
    input[type="text"], input[type="date"], input[type="number"], select, textarea {
      width: 100%;
      padding: 12px 15px;
      border-radius: 8px;
      border: 1px solid var(--cor-borda);
      font-size: 16px;
      box-sizing: border-box;
    }
    textarea {
      resize: vertical;
    }
    .input-with-checkbox {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 15px;
        align-items: center;
    }
    .input-with-checkbox label {
        font-weight: normal;
        margin-bottom: 0;
        white-space: nowrap;
    }
    /* --- Estilos para grupos de Checkbox/Radio --- */
    .selection-group {
        display: flex;
        flex-wrap: wrap;
        gap: 10px 20px;
    }
    .selection-group label {
        display: inline-flex;
        align-items: center;
        width: auto;
        font-weight: normal;
        gap: 6px;
    }

    /* --- BOTÃO PRINCIPAL --- */
    #btnGerarLaudo {
      width: 100%;
      padding: 15px;
      font-size: 18px;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s ease-in-out;
    }
    #btnGerarLaudo:hover {
      background-color: #218838;
    }
    /* --- SEÇÃO DE PEÇAS --- */
    #pecasLista h4 {
      margin-top: 20px; margin-bottom: 15px; padding-bottom: 8px;
      border-bottom: 2px solid var(--cor-primaria); color: var(--cor-titulo);
    }
    #pecasLista h4:first-child { margin-top: 0; }
    .peca-item {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 15px;
      align-items: center;
      margin-bottom: 10px;
    }
    .peca-item label {
        font-weight: normal;
    }
    .quantidade-input {
      width: 70px;
      padding: 8px;
      text-align: center;
    }
    /* --- PREVIEW DAS FOTOS --- */
    #previewFotos {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }
    .preview-img {
      width: 150px;
      height: 150px;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid var(--cor-borda);
    }
    .hidden {
        display: none;
    }
  </style>
</head>
<body>
  <h1>Gerador de Laudo Técnico - Iluminação</h1>

  <form id="laudoForm">
    <div class="form-section">
      <h2>Informações Gerais</h2>
      <div class="form-group">
        <label for="cliente">Cliente:</label>
        <input type="text" id="cliente" required>
      </div>
      <div class="form-group">
        <label for="raId">RA/ID:</label>
        <input type="text" id="raId" required>
      </div>
       <div class="form-group">
        <label for="dataEntrada">Data de Entrada:</label>
        <input type="date" id="dataEntrada" required>
      </div>
      <div class="form-group">
        <label for="modelo">Modelo do Equipamento:</label>
        <select id="modelo" required>
          <option value="">-- Escolha --</option>
        </select>
      </div>
      <div class="form-group">
        <label for="dataFabricacao">Data de Fabricação:</label>
        <div class="input-with-checkbox">
            <input type="date" id="dataFabricacao" required>
            <label><input type="checkbox" onclick="toggleInput(this, 'dataFabricacao')"> Não tem</label>
        </div>
      </div>
      <div class="form-group">
        <label for="codDefeito">Defeito Apresentado:</label>
        <select id="codDefeito" required>
          <option value="">-- Escolha --</option>
        </select>
      </div>
      <div class="form-group">
        <label for="codCausa">Causa:</label>
        <select id="codCausa" required>
          <option value="">-- Escolha --</option>
        </select>
      </div>
      <div class="form-group">
        <label for="garantia">Está em Garantia?</label>
        <select id="garantia" required>
          <option value="">-- Escolha --</option>
          <option value="Técnica">Técnica</option>
          <option value="Cortesia">Cortesia</option>
          <option value="S/ Anomalia">S/ Anomalia</option>
          <option value="Garantia/Reincidência">Garantia/Reincidência</option>
          <option value="S/ Garantia">S/ Garantia</option>
        </select>
      </div>
    </div>

    <div class="form-section">
      <h2>Informações Adicionais</h2>
      <div class="selection-group" id="infoAdicionais">
        </div>
    </div>

    <div class="form-section">
      <h2>Solução Aplicada</h2>
      <div class="selection-group" id="solucoes">
        </div>
    </div>

     <div class="form-section">
      <h2>Fornecedor</h2>
      <div class="selection-group" id="fornecedores">
        </div>
    </div>

    <div class="form-section">
      <h2>Observações Técnicas</h2>
      <div class="form-group">
          <textarea id="obsTecnicas" rows="6"></textarea>
      </div>
    </div>

    <div class="form-section hidden" id="pecasBox">
        <h2>Peças para Reposição</h2>
        <div id="pecasLista"></div>
    </div>

    <div class="form-section">
      <h2>Fotos do Equipamento</h2>
      <div class="form-group">
        <label for="fotos">Carregar fotos (múltiplas):</label>
        <input type="file" id="fotos" multiple accept="image/*">
        <div id="previewFotos"></div>
      </div>
    </div>

    <button type="button" id="btnGerarLaudo" onclick="gerarLaudo()">Gerar Laudo Técnico</button>
  </form>

<script>
// --- CONSTANTES PARA A API DO GOOGLE SHEETS ---
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxWj_HQdKJdnq3_XYuL2pP3DP4ZzuRhfjbPgRGwZTivdLH03DEP954BRhnfFLikgCCZ/exec';
const TOKEN = 'MEU_TOKEN_SEGURO_123';

// --- BANCO DE DADOS INICIAL - ILUMINAÇÃO ---
const dadosEquipamentos = {
    modelos: {
        "LED COB AÇO INOX 316 RGB 10W/ 1,5M": {
            familia: "COB",
            codigo: "22190",
            pecas: {
                "Componentes Principais": { "22190": "Necessita a troca do Equipamento", "": "Sem Anomalia", "_____": "Mão de Obra" },
            }
        },
        "LED COB PLÁSTICO RGB 5W/ 1,5M": {
            familia: "COB",
            codigo: "22928",
            pecas: {
                "Componentes Principais": { "22928": "Necessita a troca do Equipamento", "": "Sem Anomalia", "_____": "Mão de Obra" },
            }
        },
        "HIPER LED RGB 9W – CORPO/FRONTAL ABS (25MM)": {
            familia: "HIPERLED",
            codigo: "19213",
            pecas: {
                "Componentes Principais": { "19373": "Aro Inox Polido", "": "Sem Anomalia", "_____": "Mão de Obra" },
            }
        },
        "HIPER LED RGB 9W – CORPO ABS/FRONTAL INOX (25MM)": {
            familia: "HIPERLED",
            codigo: "19218",
            pecas: {
                "Componentes Principais": { "19373": "Aro Inox Polido", "": "Sem Anomalia", "_____": "Mão de Obra" },
            }
        },
        "HIPER LED RGB 9W – CORPO/FRONTAL ABS (50MM)": {
            familia: "HIPERLED",
            codigo: "19206",
            pecas: {
                // CORREÇÃO AQUI: Removida uma aspa dupla extra
                "Componentes Principais": { "19340": "Acabamento Plástico Branco Hiper LED", "": "Sem Anomalia", "_____": "Mão de Obra" },
            }
        },
        "HIPER LED RGB 9W – CORPO ABS/FRONTAL INOX (50MM)": {
            familia: "HIPERLED",
            codigo: "18343",
            pecas: {
                "Componentes Principais": { "20489": "Aro Aço Frontal Inox", "": "Sem Anomalia", "_____": "Mão de Obra" },
            }
        },
        "HIPER LED BRANCO 9W – CORPO ABS/FRONTAL INOX (50MM)": {
            familia: "HIPERLED",
            codigo: "19874",
            pecas: {
                "Componentes Principais": { "20489": "Aro Aço Frontal Inox", "": "Sem Anomalia", "_____": "Mão de Obra" },
            }
        },
        "HIPER LED AZUL 9W – CORPO ABS/FRONTAL INOX (50MM)": {
            familia: "HIPERLED",
            codigo: "19875",
            pecas: {
                "Componentes Principais": { "20489": "Aro Aço Frontal Inox", "": "Sem Anomalia", "_____": "Mão de Obra" },
            }
        },
        "LED SMD RGB 5W (50MM)": {
            familia: "SMD",
            codigo: "18345",
            pecas: {
                "Componentes Principais": {
                    "16920": "Kit Acabamento para Luminaria",
                    "16921": "Kit Vedação para Luminaria",
                    "24333": "Placa SMD RGB 5W",
                    "_____": "Mão de Obra", 
                    "": "Sem Anomalia"
                },
            }
        },
        "LED SMD RGB 9W (50MM)": {
            familia: "SMD",
            codigo: "18344",
            pecas: {
                "Componentes Principais": {
                    "16920": "Kit Acabamento para Luminaria",
                    "16921": "Kit Vedação para Luminaria",
                    "16923": "Placa SMD 61 RGB 9W",
                    "_____": "Mão de Obra",
                    "": "Sem Anomalia"
                },
            }
        },
        "LED SMD BRANCO 9W (50MM)": {
            familia: "SMD",
            codigo: "18295",
            pecas: {
                "Componentes Principais": {
                   "16920": "Kit Acabamento para Luminaria",
                   "16921": "Kit Vedação para Luminaria",
                   "16924": "Placa SMD 61 Branca 9W",
                   "_____": "Mão de Obra",
                   "": "Sem Anomalia"
                },
            }
        },
        "LED SMD AZUL 9W (50MM)": {
            familia: "SMD",
            codigo: "18294",
            pecas: {
                "Componentes Principais": {
                   "16920": "Kit Acabamento para Luminaria",
                   "16921": "Kit Vedação para Luminaria",
                   "16925": "Placa SMD 61 Azul 9W",
                   "_____": "Mão de Obra",
                   "": "Sem Anomalia"
                },
            }
        },
        "LED SMD UNIVERSAL RGB 11W": {
            familia: "SMD",
            codigo: "18347",
            pecas: {
                "Componentes Principais": {
                   "16355": "Aro Plástico",
                   "16947": "Kit Vedação para Luminaria",
                   "_____": "Mão de Obra",
                   "": "Sem Anomalia"
                },
            }
        },
        "LED SMD UNIVERSAL RGB 36W": {
            familia: "SMD",
            codigo: "18325",
            pecas: {
                "Componentes Principais": {
                   "16355": "Aro Plástico",
                   "16947": "Kit Vedação para Luminaria",
                   "_____": "Mão de Obra",
                   "": "Sem Anomalia"
                },
            }
        },
        "LED SMD BRANCO 36W": {
            familia: "SMD",
            codigo: "18340",
            pecas: {
                "Componentes Principais": {
                   "16355": "Aro Plástico",
                   "16947": "Kit Vedação para Luminaria",
                   "_____": "Mão de Obra",
                   "": "Sem Anomalia"
                },
            }
        },
    }, 

    defeitos: {
        "RF0001": "Infiltração",
        "RF0002": "Iluminação",
        "RF0003": "Oxidação",
        "RF0004": "Corpo Quebrado",
        "RF0005": "Sem Anomalia",
    },
    causas: {
        "RF0006": "Capilaridade",
        "RF0007": "Montagem / Aperto",
        "RF0008": "Lente Plástica Quebrada",
        "RF0009": "Lente de Vidro Quebrada",
        "RF0010": "Placa Queimada",
        "RF0011": "Lâmpada Queimada",
        "RF0012": "Conector Solto",
        "RF0013": "Montagem (Placa Invertida)",
        "RF0014": "Trilha Rompida",
        "RF0015": "LED Verde Queimado",
        "RF0016": "LED Azul Queimado",
        "RF0017": "LED Vermelho Queimado",
        "RF0018": "Eletrolise",
        "RF0019": "Frontal Amarelado",
        "RF0020": "Frontal Oxidado",
        "RF0021": "Tratamento Químico d’Água",
        "RF0022": "Chegou ao Cliente Quebrado",
        "RF0023": "Quebrou na Remoção",
        "RF0024": "Nada Evidenciado",
    },
    informacoesAdicionais: [
        "Faltando acessórios na peça",
        "Cabo cortado",
        "Estado de novo",
        "Marcas de uso",
        "Faltando frontal inox",
        "Outros",
    ],
    solucoes: [
        "Troca do equipamento",
        "Troca de acessório",
        "Conserto do equipamento",
        "Sem anomalia / Simples retorno",
    ],
    fornecedores: [ "QX", "LUXXEL"]
};

// --- FUNÇÕES DE PREENCHIMENTO E LÓGICA DO FORMULÁRIO ---
window.onload = function() {
    const modeloSelect = document.getElementById('modelo');
    const defeitoSelect = document.getElementById('codDefeito');
    const causaSelect = document.getElementById('codCausa');
    for (const nomeModelo in dadosEquipamentos.modelos) {
        modeloSelect.innerHTML += `<option value="${nomeModelo}">${nomeModelo}</option>`;
    }
    for (const codDefeito in dadosEquipamentos.defeitos) {
        defeitoSelect.innerHTML += `<option value="${codDefeito}">${codDefeito} - ${dadosEquipamentos.defeitos[codDefeito]}</option>`;
    }
    for (const codCausa in dadosEquipamentos.causas) {
        causaSelect.innerHTML += `<option value="${codCausa}">${codCausa} - ${dadosEquipamentos.causas[codCausa]}</option>`;
    }
    const infoAdicionaisContainer = document.getElementById('infoAdicionais');
    dadosEquipamentos.informacoesAdicionais.forEach(info => {
        infoAdicionaisContainer.innerHTML += `<label><input type="checkbox" name="infoAdicionais" value="${info}"> ${info}</label>`;
    });
    const solucoesContainer = document.getElementById('solucoes');
    dadosEquipamentos.solucoes.forEach(solucao => {
        solucoesContainer.innerHTML += `<label><input type="radio" name="solucao" value="${solucao}"> ${solucao}</label>`;
    });
    const fornecedoresContainer = document.getElementById('fornecedores');
    dadosEquipamentos.fornecedores.forEach(fornecedor => {
        fornecedoresContainer.innerHTML += `<label><input type="radio" name="fornecedor" value="${fornecedor}"> ${fornecedor}</label>`;
    });
};

document.getElementById('modelo').addEventListener('change', function() {
    const selectedModelName = this.value;
    const pecasBox = document.getElementById('pecasBox');
    const pecasLista = document.getElementById('pecasLista');
    pecasLista.innerHTML = '';
    if (!selectedModelName) {
        pecasBox.classList.add('hidden');
        return;
    }
    const pecasDoModelo = dadosEquipamentos.modelos[selectedModelName].pecas;
    if (pecasDoModelo && Object.keys(pecasDoModelo).length > 0) {
        for (const categoria in pecasDoModelo) {
            pecasLista.innerHTML += `<h4>${categoria}</h4>`;
            for (const codigo in pecasDoModelo[categoria]) {
                const nomePeca = pecasDoModelo[categoria][codigo];
                pecasLista.innerHTML += `
                        <div class="peca-item">
                            <label><input type="checkbox" name="pecas" value="${codigo}" data-nome="${nomePeca}"> ${nomePeca}</label>
                            <input type="number" class="quantidade-input" value="1" min="1">
                        </div>`;
            }
        }
        pecasBox.classList.remove('hidden');
    } else {
        pecasBox.classList.add('hidden');
    }
});

const imagensParaLaudo = [];
document.getElementById("fotos").addEventListener("change", function(event) {
    const preview = document.getElementById("previewFotos");
    preview.innerHTML = "";
    imagensParaLaudo.length = 0;
    Array.from(event.target.files).forEach(file => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = document.createElement("img");
            img.src = e.target.result;
            img.classList.add("preview-img");
            preview.appendChild(img);
            imagensParaLaudo.push(e.target.result);
        }
        reader.readAsDataURL(file);
    });
});

function toggleInput(checkbox, inputId) {
    const input = document.getElementById(inputId);
    input.disabled = checkbox.checked;
    if (checkbox.checked) {
        input.value = '';
        input.required = false;
    } else {
        input.required = true;
    }
}

// --- FUNÇÃO GERAR LAUDO ---
function gerarLaudo() {
    // 1. VALIDAÇÃO DOS CAMPOS
    const erros = [];
    // "obsTecnicas" foi removido da validação
    const camposObrigatorios = {
        cliente: "Cliente", raId: "RA/ID", dataEntrada: "Data de Entrada", modelo: "Modelo do Equipamento",
        codDefeito: "Defeito Apresentado", codCausa: "Causa",
        garantia: "Garantia"
    };
    const dataFabricacaoInput = document.getElementById('dataFabricacao');
    if (!dataFabricacaoInput.disabled && !dataFabricacaoInput.value) {
        erros.push("O campo 'Data de Fabricação' é obrigatório (ou marque 'Não tem').");
    }
    for (const id in camposObrigatorios) {
        if (!document.getElementById(id).value) {
            erros.push(`O campo '${camposObrigatorios[id]}' é obrigatório.`);
        }
    }
    if (imagensParaLaudo.length === 0) {
        erros.push("É necessário anexar pelo menos uma foto.");
    }
    if (erros.length > 0) {
        alert("Por favor, corrija os seguintes erros:\n\n- " + erros.join("\n- "));
        return;
    }

    // 2. COLETA DE DADOS
    const modeloSelecionado = document.getElementById("modelo").value;
    const infoModelo = dadosEquipamentos.modelos[modeloSelecionado];
    const codDefeitoSelecionado = document.getElementById("codDefeito").value;
    const nomeDefeito = dadosEquipamentos.defeitos[codDefeitoSelecionado];
    const codCausaSelecionado = document.getElementById("codCausa").value;
    const nomeCausa = dadosEquipamentos.causas[codCausaSelecionado];
    const dataFabricacaoValue = dataFabricacaoInput.disabled ? "Não informado" : new Date(dataFabricacaoInput.value).toLocaleDateString('pt-BR', {timeZone: 'UTC'});
    const dataEntradaValue = new Date(document.getElementById('dataEntrada').value).toLocaleDateString('pt-BR', {timeZone: 'UTC'});

    // Lógica para verificar se as observações estão vazias
    const obsValue = document.getElementById("obsTecnicas").value.trim();

    // Objeto para o LAUDO VISUAL
    const laudoData = {
        raId: document.getElementById("raId").value,
        cliente: document.getElementById("cliente").value,
        dataGeracao: new Date().toLocaleDateString('pt-BR'),
        dataEntrada: dataEntradaValue,
        equipamento: modeloSelecionado,
        familiaEquipamento: infoModelo.familia,
        codigoEquipamento: infoModelo.codigo,
        dataFabricacao: dataFabricacaoValue,
        defeito: `${codDefeitoSelecionado} - ${nomeDefeito}`,
        causa: `${codCausaSelecionado} - ${nomeCausa}`,
        garantia: document.getElementById("garantia").value,
        solucao: document.querySelector('input[name="solucao"]:checked')?.value || "Nenhuma informada",
        fornecedor: document.querySelector('input[name="fornecedor"]:checked')?.value || "Nenhum informado",
        obsTecnicas: obsValue ? obsValue.replace(/\n/g, '<br>') : 'Não tem',
        informacoesAdicionais: Array.from(document.querySelectorAll('input[name="infoAdicionais"]:checked')).map(el => el.value),
        pecasSelecionadas: Array.from(document.querySelectorAll('#pecasLista input[type="checkbox"]:checked')).map(el => {
            const quantidadeInput = el.closest('.peca-item').querySelector('.quantidade-input');
            return { codigo: el.value, nome: el.dataset.nome, quantidade: quantidadeInput.value };
        }),
        imagens: imagensParaLaudo
    };

    // Objeto para a PLANILHA (formato esperado pelo Apps Script)
    const payloadParaPlanilha = {
        token: TOKEN,
        raId: laudoData.raId,
        dataEntrada: laudoData.dataEntrada,
        cliente: laudoData.cliente,
        modelo: laudoData.equipamento,
        codigo: laudoData.codigoEquipamento,
        familia: laudoData.familiaEquipamento,
        dataFabricacao: laudoData.dataFabricacao,
        informacoesAdicionais: laudoData.informacoesAdicionais,
        defeito: nomeDefeito,
        codigoDefeito: codDefeitoSelecionado,
        causa: nomeCausa,
        codigoCausa: codCausaSelecionado,
        obsTecnicas: laudoData.obsTecnicas,
        tipoGarantia: laudoData.garantia,
        solucao: laudoData.solucao,
        fornecedor: laudoData.fornecedor,
        pecas: laudoData.pecasSelecionadas
    };


    // 3. GERAÇÃO DA NOVA JANELA COM O LAUDO
    const novaJanela = window.open('', '_blank');
    novaJanela.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Laudo Técnico - RA/ID ${laudoData.raId}</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 0; background-color: #fff; color: #333; }
            .container { max-width: 800px; margin: 20px auto; }
            .section { margin-bottom: 25px; page-break-inside: avoid; }
            .section h2 { font-size: 14px; font-weight: bold; color: #fff; background-color: #002060; padding: 8px; margin: 0 0 15px 0; border-radius: 4px; }
            .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0 15px; padding: 10px; border: 1px solid #eee; border-radius: 4px; }
            .info-item { padding: 8px 0; border-bottom: 1px dotted #ccc; }
            .info-grid > .info-item:nth-last-of-type(-n+2) { border-bottom: none; }
            .info-item span { font-weight: bold; }
            .full-width { grid-column: 1 / -1; }
            p { font-size: 14px; line-height: 1.5; padding: 0 10px; margin:0; }
            ul { padding-left: 30px; margin: 10px 0 0 0; } li { margin-bottom: 5px; }
            .header-table { width: 100%; border-collapse: collapse; margin-bottom: 40px; border: 1px solid #ccc; }
            .header-table td { border: 1px solid #000; padding: 5px; vertical-align: middle; }
            .logo-cell { width: 200px; text-align: center; padding: 10px; }
            .logo-cell img { max-width: 180px; height: auto; }
            .info-table { width: 100%; }
            .info-table td { border: 1px solid #000; padding: 8px; font-size: 16px; }
            .company-name { background-color: #002060; color: white; font-weight: bold; text-align: center; font-size: 20px; padding: 8px; }
            .pecas-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
            .pecas-table th, .pecas-table td { border: 1px solid #000; padding: 8px; text-align: left; font-size: 14px; }
            .pecas-table th { background-color: #e9ecef; }
            .fotos-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
            .fotos-grid img { width: 100%; height: 5cm; object-fit: contain; border-radius: 4px; border: 1px solid #ccc; background-color: #f9f9f9; }
            .assinaturas-section { display: flex; justify-content: space-around; margin-top: 80px; text-align: center; }
            .assinatura-box { width: 300px; }
            .assinatura-linha { border-top: 1px solid #000; margin-top: 5px; padding-top: 5px; }
            .button-container { text-align: center; margin-top: 30px; }
            .button { padding: 12px 25px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; color: white; margin: 0 10px; }
            .print-btn { background-color: #007bff; }
            .save-btn { background-color: #28a745; }
            .save-btn:disabled { background-color: #6c757d; cursor: not-allowed; }
            @media print {
              .no-print { display: none; }
              body { margin: 0; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
              .section h2 { background-color: #002060 !important; color: #fff !important; }
            }
          </style>
        </head>
        <body>
          <div class="container">
            <table class="header-table">
              <tr>
                <td class="logo-cell"><img src="logolaudo.jpg" alt="Logo da Empresa"></td>
                <td>
                  <table class="info-table">
                    <tr><td class="company-name" colspan="2">SODRAMAR INDÚSTRIA E COMÉRCIO LTDA</td></tr>
                    <tr><td><strong>Laudo técnico</strong></td>
                      <td rowspan="2" style="text-align:center; vertical-align: middle;">${laudoData.dataGeracao}</td></tr>
                    <tr><td><strong>RA/ID:</strong> ${laudoData.raId}</td></tr>
                  </table>
                </td>
              </tr>
            </table>

            <div class="section">
              <h2>INFORMAÇÕES GERAIS</h2>
              <div class="info-grid">
                <div class="info-item"><span>Cliente:</span> ${laudoData.cliente}</div>
                <div class="info-item"><span>RA/ID:</span> ${laudoData.raId}</div>
                <div class="info-item"><span>Data de Entrada:</span> ${laudoData.dataEntrada}</div>
                <div class="info-item"><span>Data de Fabricação:</span> ${laudoData.dataFabricacao}</div>
                <div class="info-item"><span>Equipamento:</span> ${laudoData.equipamento} (${laudoData.codigoEquipamento})</div>
                <div class="info-item"><span>Família:</span> ${laudoData.familiaEquipamento}</div>
                <div class="info-item"><span>Garantia:</span> ${laudoData.garantia}</div>
                <div class="info-item full-width"><span>Defeito Apresentado:</span> ${laudoData.defeito}</div>
                <div class="info-item full-width"><span>Causa Provável:</span> ${laudoData.causa}</div>
                <div class="info-item"><span>Solução Aplicada:</span> ${laudoData.solucao}</div>
                <div class="info-item"><span>Fornecedor:</span> ${laudoData.fornecedor}</div>
              </div>
            </div>

            ${laudoData.informacoesAdicionais.length > 0 ? `
            <div class="section">
              <h2>INFORMAÇÕES ADICIONAIS</h2>
              <ul>${laudoData.informacoesAdicionais.map(info => `<li>${info}</li>`).join('')}</ul>
            </div>
            ` : ''}

            <div class="section"><h2>OBSERVAÇÕES TÉCNICAS</h2><p>${laudoData.obsTecnicas}</p></div>

            ${laudoData.pecasSelecionadas.length > 0 ? `
            <div class="section">
              <h2>PEÇAS PARA REPOSIÇÃO</h2>
              <table class="pecas-table">
                <thead><tr><th>Código</th><th>Descrição</th><th>Quantidade</th></tr></thead>
                <tbody>
                  ${laudoData.pecasSelecionadas.map(peca => `<tr><td>${peca.codigo}</td><td>${peca.nome}</td><td>${peca.quantidade}</td></tr>`).join('')}
                </tbody>
              </table>
            </div>
            ` : ''}

            <div class="section"><h2>FOTOS DO EQUIPAMENTO</h2><div class="fotos-grid">${laudoData.imagens.map(src => `<img src="${src}">`).join('')}</div></div>

            <div class="assinaturas-section">
                <div class="assinatura-box"><div class="assinatura-linha">Supervisor</div></div>
                <div class="assinatura-box"><div class="assinatura-linha">Técnico</div></div>
            </div>

            <div class="button-container no-print">
              <button id="saveBtn" class="button save-btn" onclick="salvarNaPlanilha()">Salvar na Planilha</button>
              <button class="button print-btn" onclick="window.print()">Imprimir / Salvar PDF</button>
            </div>
          </div>

          <script>
              const WEB_APP_URL = '${WEB_APP_URL}';
              const payload = ${JSON.stringify(payloadParaPlanilha)};

              async function salvarNaPlanilha() {
                  const btn = document.getElementById('saveBtn');
                  btn.disabled = true;
                  btn.textContent = 'Salvando...';

                  try {
                      const response = await fetch(WEB_APP_URL, {
                          method: 'POST',
                          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                          body: JSON.stringify(payload),
                          mode: 'cors'
                      });
                      
                      const result = await response.json();

                      if (result.ok) {
                          alert('Dados salvos na planilha com sucesso! ✅');
                          btn.textContent = 'Salvo com Sucesso!';
                          btn.style.backgroundColor = '#17a2b8';
                      } else {
                          throw new Error(result.error || 'Erro retornado pelo servidor.');
                      }
                  } catch (error) {
                      console.error('Erro detalhado:', error);
                      alert('❌ Falha ao salvar os dados na planilha.\\n\\nCausa provável: URL do App incorreta, Token inválido ou erro no script.\\nVerifique o console (F12) para detalhes.');
                      btn.disabled = false;
                      btn.textContent = 'Tentar Salvar Novamente';
                  }
              }
          <\/script>
        </body>
        </html>
    `);
    novaJanela.document.close();
}
</script>
</body>
</html>
Feito por Laboratório
